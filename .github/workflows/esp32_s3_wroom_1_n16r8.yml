name: Compile MicroPython for boards/esp32_s3_wroom_1_n16r8.yml

on:
  push:
    branches:
      - main
    tags:
      - '*'

permissions:
  contents: write
      
jobs:
    build:
      runs-on: ubuntu-latest
  
      env:
        BOARD: ESP32_S3_WROOM_1_N16R8
        BOARD_DIR: boards/${BOARD}
        BUILD_DIR: boards/${BOARD}/build
        PORT_DIR: lib/micropython/ports/esp32
  
      steps:

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # submodules: 'recursive' is inefficient, as it checks out many submodules we don't need
          submodules: ''

      - name: Checkout required submodules
        run: |
          echo workspace ${{ github.workspace }}
          ls -l ${{ github.workspace }}
          git submodule update --init lib/micropython
          cd lib/micropython; git submodule update --init lib/berkeley-db-1.xx lib/micropython-lib
      
      - name: Compile (in esp-idf docker)
        uses: addnab/docker-run-action@v3
        with:
          image: espressif/idf:v5.0.4
          options: -v ${{ github.workspace }}:/project -w /project
          run: |
            bash -c " \
              make -C /project/lib/micropython/mpy-cross; \
              cd /project/$(BOARD_DIR); \
              idf.py build; \
              cd /project/$(PORT_DIR); \
              python makeimg.py \
                /project/$(BUILD_DIR)/sdkconfig \
                /project/$(BUILD_DIR)/bootloader/bootloader.bin \
                /project/$(BUILD_DIR)/partition_table/partition-table.bin \
                /project/$(BUILD_DIR)/micropython.bin \
                /project/$(BUILD_DIR)/firmware.bin \
                /project/$(BUILD_DIR)/micropython.uf2"

      - name: Release
        working-directory: ${{ env.BUILD_DIR }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          cd ${{ env.BUILD_DIR }} && \
          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${GITHUB_REPOSITORY#*/} MicroPython $${{ env.BOARD }} ${tag#v}" \
              --generate-notes \
              micropython.bin \
              firmware.bin \
              micropython.uf2
              
      

